# 03. æ•°æ®åº“è®¾è®¡

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†æ—…æ¸¸æœåŠ¡ç³»ç»Ÿçš„æ•°æ®åº“è®¾è®¡ï¼ŒåŒ…æ‹¬è¡¨ç»“æž„ã€å…³ç³»å’Œçº¦æŸã€‚

## ðŸ“Š æ•°æ®åº“æ¦‚è§ˆ

- **æ•°æ®åº“ç±»åž‹**: SQLite
- **è¡¨æ•°é‡**: 15 å¼ æ ¸å¿ƒæ•°æ®è¡¨
- **å­˜å‚¨ä½ç½®**: `data/travel.db`
- **å­—ç¬¦é›†**: UTF-8

## ðŸ—„ï¸ æ•°æ®åº“ ER å›¾

```mermaid
erDiagram
    PROFILES ||--o{ SPOT_COMMENTS : creates
    PROFILES ||--o{ SPOT_FAVORITES : has
    PROFILES ||--o{ SPOT_LIKES : gives
    PROFILES ||--o{ ORDERS : places
    PROFILES ||--o{ HOTEL_BOOKINGS : makes
    PROFILES ||--o{ ACTIVITY_BOOKINGS : joins

    SPOT_CATEGORIES ||--o{ SPOTS : categorizes
    SPOTS ||--o{ SPOT_COMMENTS : receives
    SPOTS ||--o{ SPOT_FAVORITES : favorited_by
    SPOTS ||--o{ SPOT_LIKES : liked_by
    SPOTS ||--o{ TICKETS : offers
    SPOTS ||--o{ ACTIVITIES : hosts

    TICKETS ||--o{ CART_ITEMS : added_to
    ORDERS ||--o{ ORDER_ITEMS : contains
    TICKETS ||--o{ ORDER_ITEMS : ordered

    HOTELS ||--o{ HOTEL_ROOMS : has
    HOTEL_ROOMS ||--o{ HOTEL_BOOKINGS : booked
```

## ðŸ“‹ æ•°æ®è¡¨è¯¦æƒ…

### 1. ç”¨æˆ·è¡¨ (profiles)

å­˜å‚¨ç”¨æˆ·åŸºæœ¬ä¿¡æ¯å’Œè®¤è¯æ•°æ®ã€‚

```sql
CREATE TABLE profiles (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    email TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    full_name TEXT NOT NULL,
    role TEXT NOT NULL DEFAULT 'user', -- 'user', 'guide', 'admin'
    avatar_url TEXT,
    phone TEXT,
    bio TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**å­—æ®µè¯´æ˜Ž**ï¼š
- `id`: ç”¨æˆ·å”¯ä¸€æ ‡è¯†
- `email`: é‚®ç®±ï¼Œç”¨äºŽç™»å½•
- `password_hash`: å¯†ç å“ˆå¸Œå€¼ï¼ˆbcrypt åŠ å¯†ï¼‰
- `role`: ç”¨æˆ·è§’è‰²
- `avatar_url`: å¤´åƒ URL
- `bio`: ä¸ªäººç®€ä»‹

### 2. æ™¯ç‚¹åˆ†ç±»è¡¨ (spot_categories)

æ™¯ç‚¹åˆ†ç±»ç®¡ç†ã€‚

```sql
CREATE TABLE spot_categories (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT UNIQUE NOT NULL,
    description TEXT,
    icon TEXT,
    color TEXT DEFAULT '#3B82F6',
    sort_order INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**ç¤ºä¾‹æ•°æ®**ï¼š
- è‡ªç„¶é£Žå…‰
- åŽ†å²å¤è¿¹
- ä¸»é¢˜å…¬å›­
- åšç‰©é¦†
- å®—æ•™åœºæ‰€

### 3. æ™¯ç‚¹è¡¨ (spots)

å­˜å‚¨æ™¯ç‚¹è¯¦ç»†ä¿¡æ¯ã€‚

```sql
CREATE TABLE spots (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    description TEXT,
    category_id INTEGER,
    location TEXT NOT NULL,
    latitude REAL,
    longitude REAL,
    price REAL DEFAULT 0,
    images TEXT, -- JSON æ•°ç»„
    status INTEGER DEFAULT 1, -- 1: æ­£å¸¸, 0: åˆ é™¤
    created_by INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (category_id) REFERENCES spot_categories(id),
    FOREIGN KEY (created_by) REFERENCES profiles(id)
);
```

### 4. æ™¯ç‚¹è¯„è®ºè¡¨ (spot_comments)

ç”¨æˆ·å¯¹æ™¯ç‚¹çš„è¯„è®ºå’Œè¯„åˆ†ã€‚

```sql
CREATE TABLE spot_comments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    spot_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,
    content TEXT NOT NULL,
    rating INTEGER NOT NULL CHECK(rating >= 1 AND rating <= 5),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (spot_id) REFERENCES spots(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES profiles(id) ON DELETE CASCADE
);
```

### 5. æ™¯ç‚¹æ”¶è—è¡¨ (spot_favorites)

ç”¨æˆ·æ”¶è—çš„æ™¯ç‚¹ã€‚

```sql
CREATE TABLE spot_favorites (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    spot_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(spot_id, user_id),
    FOREIGN KEY (spot_id) REFERENCES spots(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES profiles(id) ON DELETE CASCADE
);
```

### 6. æ™¯ç‚¹ç‚¹èµžè¡¨ (spot_likes)

ç”¨æˆ·ç‚¹èµžçš„æ™¯ç‚¹ã€‚

```sql
CREATE TABLE spot_likes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    spot_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(spot_id, user_id),
    FOREIGN KEY (spot_id) REFERENCES spots(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES profiles(id) ON DELETE CASCADE
);
```

### 7. é—¨ç¥¨è¡¨ (tickets)

æ™¯ç‚¹é—¨ç¥¨ä¿¡æ¯ã€‚

```sql
CREATE TABLE tickets (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    spot_id INTEGER NOT NULL,
    name TEXT NOT NULL,
    description TEXT,
    price REAL NOT NULL,
    original_price REAL,
    type TEXT DEFAULT 'adult', -- 'adult', 'child', 'student', 'senior'
    stock INTEGER DEFAULT 0,
    sales_count INTEGER DEFAULT 0,
    valid_days INTEGER DEFAULT 1, -- æœ‰æ•ˆå¤©æ•°
    status INTEGER DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (spot_id) REFERENCES spots(id) ON DELETE CASCADE
);
```

### 8. è´­ç‰©è½¦è¡¨ (cart_items)

ç”¨æˆ·è´­ç‰©è½¦ã€‚

```sql
CREATE TABLE cart_items (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    ticket_id INTEGER NOT NULL,
    quantity INTEGER NOT NULL DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES profiles(id) ON DELETE CASCADE,
    FOREIGN KEY (ticket_id) REFERENCES tickets(id) ON DELETE CASCADE
);
```

### 9. è®¢å•è¡¨ (orders)

ç”¨æˆ·è®¢å•ä¸»è¡¨ã€‚

```sql
CREATE TABLE orders (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    order_no TEXT UNIQUE NOT NULL,
    total_amount REAL NOT NULL,
    status TEXT DEFAULT 'pending', -- 'pending', 'paid', 'cancelled', 'refunded'
    payment_method TEXT,
    payment_id TEXT,
    contact_name TEXT,
    contact_phone TEXT,
    contact_email TEXT,
    notes TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES profiles(id)
);
```

### 10. è®¢å•è¯¦æƒ…è¡¨ (order_items)

è®¢å•ä¸­çš„é—¨ç¥¨è¯¦æƒ…ã€‚

```sql
CREATE TABLE order_items (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    order_id INTEGER NOT NULL,
    ticket_id INTEGER NOT NULL,
    quantity INTEGER NOT NULL,
    price REAL NOT NULL,
    subtotal REAL NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE,
    FOREIGN KEY (ticket_id) REFERENCES tickets(id)
);
```

### 11. é…’åº—è¡¨ (hotels)

é…’åº—ä¿¡æ¯ã€‚

```sql
CREATE TABLE hotels (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    description TEXT,
    location TEXT NOT NULL,
    address TEXT,
    latitude REAL,
    longitude REAL,
    star_rating INTEGER DEFAULT 3,
    facilities TEXT, -- JSON æ•°ç»„
    images TEXT, -- JSON æ•°ç»„
    status INTEGER DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 12. é…’åº—æˆ¿é—´è¡¨ (hotel_rooms)

é…’åº—æˆ¿é—´ä¿¡æ¯ã€‚

```sql
CREATE TABLE hotel_rooms (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    hotel_id INTEGER NOT NULL,
    name TEXT NOT NULL,
    type TEXT, -- 'single', 'double', 'suite', 'deluxe'
    price REAL NOT NULL,
    capacity INTEGER DEFAULT 2,
    area REAL, -- é¢ç§¯ï¼ˆå¹³æ–¹ç±³ï¼‰
    beds TEXT, -- åºŠåž‹æè¿°
    amenities TEXT, -- JSON æ•°ç»„
    images TEXT, -- JSON æ•°ç»„
    status INTEGER DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (hotel_id) REFERENCES hotels(id) ON DELETE CASCADE
);
```

### 13. é…’åº—é¢„è®¢è¡¨ (hotel_bookings)

é…’åº—é¢„è®¢è®°å½•ã€‚

```sql
CREATE TABLE hotel_bookings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    room_id INTEGER NOT NULL,
    check_in DATE NOT NULL,
    check_out DATE NOT NULL,
    nights INTEGER NOT NULL,
    price REAL NOT NULL,
    total_amount REAL NOT NULL,
    status TEXT DEFAULT 'pending', -- 'pending', 'confirmed', 'cancelled'
    guest_name TEXT,
    guest_phone TEXT,
    notes TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES profiles(id),
    FOREIGN KEY (room_id) REFERENCES hotel_rooms(id)
);
```

### 14. æ—…æ¸¸æ´»åŠ¨è¡¨ (activities)

æ—…æ¸¸æ´»åŠ¨ä¿¡æ¯ã€‚

```sql
CREATE TABLE activities (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    spot_id INTEGER,
    title TEXT NOT NULL,
    description TEXT,
    type TEXT, -- 'tour', 'workshop', 'performance', etc.
    start_date DATETIME NOT NULL,
    end_date DATETIME NOT NULL,
    max_participants INTEGER,
    current_participants INTEGER DEFAULT 0,
    price REAL DEFAULT 0,
    images TEXT, -- JSON æ•°ç»„
    status INTEGER DEFAULT 1,
    created_by INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (spot_id) REFERENCES spots(id),
    FOREIGN KEY (created_by) REFERENCES profiles(id)
);
```

### 15. æ–°é—»è¡¨ (news)

æ–°é—»å…¬å‘Šã€‚

```sql
CREATE TABLE news (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    summary TEXT,
    author_id INTEGER,
    images TEXT, -- JSON æ•°ç»„
    view_count INTEGER DEFAULT 0,
    status INTEGER DEFAULT 1, -- 1: å·²å‘å¸ƒ, 0: è‰ç¨¿
    is_top INTEGER DEFAULT 0, -- æ˜¯å¦ç½®é¡¶
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (author_id) REFERENCES profiles(id)
);
```

## ðŸ” ç´¢å¼•è®¾è®¡

ä¸ºäº†æé«˜æŸ¥è¯¢æ€§èƒ½ï¼Œæ•°æ®åº“åˆ›å»ºäº†ä»¥ä¸‹ç´¢å¼•ï¼š

```sql
-- ç”¨æˆ·è¡¨ç´¢å¼•
CREATE INDEX idx_profiles_email ON profiles(email);
CREATE INDEX idx_profiles_role ON profiles(role);

-- æ™¯ç‚¹è¡¨ç´¢å¼•
CREATE INDEX idx_spots_category ON spots(category_id);
CREATE INDEX idx_spots_status ON spots(status);
CREATE INDEX idx_spots_location ON spots(location);

-- è¯„è®ºè¡¨ç´¢å¼•
CREATE INDEX idx_spot_comments_spot ON spot_comments(spot_id);
CREATE INDEX idx_spot_comments_user ON spot_comments(user_id);
CREATE INDEX idx_spot_comments_rating ON spot_comments(rating);

-- æ”¶è—å’Œç‚¹èµžç´¢å¼•
CREATE INDEX idx_spot_favorites_spot ON spot_favorites(spot_id);
CREATE INDEX idx_spot_favorites_user ON spot_favorites(user_id);
CREATE INDEX idx_spot_likes_spot ON spot_likes(spot_id);
CREATE INDEX idx_spot_likes_user ON spot_likes(user_id);

-- è®¢å•è¡¨ç´¢å¼•
CREATE INDEX idx_orders_user ON orders(user_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_created ON orders(created_at);
```

## ðŸ“ æ•°æ®å®Œæ•´æ€§çº¦æŸ

1. **å¤–é”®çº¦æŸ**ï¼šç¡®ä¿æ•°æ®å¼•ç”¨å®Œæ•´æ€§
2. **å”¯ä¸€çº¦æŸ**ï¼šé˜²æ­¢é‡å¤æ•°æ®
3. **æ£€æŸ¥çº¦æŸ**ï¼šç¡®ä¿æ•°æ®å€¼æœ‰æ•ˆï¼ˆå¦‚è¯„åˆ† 1-5ï¼‰
4. **éžç©ºçº¦æŸ**ï¼šå…³é”®å­—æ®µå¿…é¡»æœ‰å€¼

## ðŸš€ æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ä½¿ç”¨ç´¢å¼•**ï¼šä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µåˆ›å»ºç´¢å¼•
2. **åˆ†é¡µæŸ¥è¯¢**ï¼šå¤§æ•°æ®é‡æ—¶ä½¿ç”¨ LIMIT å’Œ OFFSET
3. **JSON å­—æ®µ**ï¼šå›¾ç‰‡åˆ—è¡¨ç­‰ä½¿ç”¨ JSON å­˜å‚¨ï¼Œå‡å°‘è¡¨å…³è”
4. **è½¯åˆ é™¤**ï¼šä½¿ç”¨ status å­—æ®µæ ‡è®°åˆ é™¤ï¼Œä¿ç•™æ•°æ®

## ðŸ”„ æ•°æ®è¿ç§»

å¦‚éœ€ä¿®æ”¹è¡¨ç»“æž„ï¼š

1. åˆ›å»ºæ–°çš„ SQL æ–‡ä»¶ `scripts/005_alter_tables.sql`
2. æ‰§è¡Œ SQL è¯­å¥ä¿®æ”¹è¡¨ç»“æž„
3. æ›´æ–° TypeScript ç±»åž‹å®šä¹‰
4. é‡ç½®æ•°æ®åº“æµ‹è¯•

## ðŸ“Š ç¤ºä¾‹æ•°æ®

ç³»ç»Ÿåˆå§‹åŒ–æ—¶ä¼šæ’å…¥ç¤ºä¾‹æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š

- 1 ä¸ªç®¡ç†å‘˜è´¦æˆ·
- 5 ä¸ªæ™¯ç‚¹åˆ†ç±»
- 20 ä¸ªæ™¯ç‚¹
- éƒ¨åˆ†è¯„è®ºå’Œè¯„åˆ†æ•°æ®
- é…’åº—å’Œæˆ¿é—´æ•°æ®
- æ–°é—»å’Œæ´»åŠ¨æ•°æ®

è¿™äº›æ•°æ®å¯ç”¨äºŽå¼€å‘å’Œæµ‹è¯•ã€‚