# 04. API 接口文档

本文档详细描述了旅游服务系统的所有 API 接口。

## 🔐 认证说明

所有需要认证的接口都需要在请求头中包含 JWT Token：

```
Authorization: Bearer <your-jwt-token>
```

获取 Token 的方式：
1. 用户登录：`POST /api/auth/login`
2. 用户注册：`POST /api/auth/register`

## 📋 API 响应格式

### 成功响应
```json
{
  "success": true,
  "data": {}, // 返回的数据
  "pagination": { // 分页信息（仅列表接口）
    "page": 1,
    "limit": 10,
    "total": 100,
    "pages": 10
  }
}
```

### 错误响应
```json
{
  "success": false,
  "error": "错误信息"
}
```

## 📝 API 列表

## 1. 认证相关

### 1.1 用户登录

- **URL**: `POST /api/auth/login`
- **描述**: 用户登录获取访问令牌
- **请求体**:
  ```json
  {
    "email": "user@example.com",
    "password": "password123"
  }
  ```
- **响应**:
  ```json
  {
    "success": true,
    "data": {
      "user": {
        "id": 1,
        "email": "user@example.com",
        "full_name": "张三",
        "role": "user"
      },
      "token": "jwt-token-string"
    }
  }
  ```

### 1.2 用户注册

- **URL**: `POST /api/auth/register`
- **描述**: 新用户注册
- **请求体**:
  ```json
  {
    "email": "user@example.com",
    "password": "password123",
    "full_name": "张三",
    "role": "user" // 可选：user, guide
  }
  ```
- **响应**: 同登录接口

### 1.3 获取当前用户信息

- **URL**: `GET /api/auth/me`
- **描述**: 获取当前登录用户信息
- **认证**: 需要
- **响应**:
  ```json
  {
    "success": true,
    "data": {
      "user": {
        "id": 1,
        "email": "user@example.com",
        "full_name": "张三",
        "role": "user",
        "avatar_url": ""
      }
    }
  }
  ```

## 2. 景点管理

### 2.1 获取景点列表

- **URL**: `GET /api/spots`
- **描述**: 获取景点列表（支持分页、搜索、筛选）
- **查询参数**:
  - `page`: 页码（默认 1）
  - `limit`: 每页数量（默认 10）
  - `search`: 搜索关键词（搜索景点名称和描述）
  - `category`: 分类名称
- **响应**:
  ```json
  {
    "success": true,
    "data": [
      {
        "id": 1,
        "name": "故宫博物院",
        "description": "中国明清两代的皇家宫殿",
        "location": "北京市东城区",
        "price": 60,
        "category_name": "历史古迹",
        "average_rating": 4.5,
        "like_count": 1000,
        "favorite_count": 500
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 100,
      "pages": 10
    }
  }
  ```

### 2.2 获取景点详情

- **URL**: `GET /api/spots/{id}`
- **描述**: 获取指定景点的详细信息
- **响应**:
  ```json
  {
    "success": true,
    "data": {
      "id": 1,
      "name": "故宫博物院",
      "description": "中国明清两代的皇家宫殿",
      "location": "北京市东城区",
      "images": ["image1.jpg", "image2.jpg"],
      "category_name": "历史古迹",
      "average_rating": 4.5,
      "comment_count": 200,
      "comments": [
        {
          "id": 1,
          "content": "非常值得参观！",
          "rating": 5,
          "full_name": "李四",
          "created_at": "2024-01-01"
        }
      ],
      "activities": [
        {
          "id": 1,
          "title": "故宫夜游",
          "booked_count": 50
        }
      ]
    }
  }
  ```

### 2.3 创建景点

- **URL**: `POST /api/spots`
- **描述**: 创建新景点（需要导游及以上权限）
- **认证**: 需要
- **权限**: guide, admin
- **请求体**:
  ```json
  {
    "name": "新景点",
    "description": "景点描述",
    "category_id": 1,
    "location": "景点地址",
    "price": 50,
    "images": ["image1.jpg"]
  }
  ```

### 2.4 更新景点

- **URL**: `PUT /api/spots/{id}`
- **描述**: 更新景点信息
- **认证**: 需要
- **权限**: 创建者或 admin

### 2.5 删除景点

- **URL**: `DELETE /api/spots/{id}`
- **描述**: 删除景点（软删除）
- **认证**: 需要
- **权限**: 创建者或 admin

## 3. 景点评论

### 3.1 获取景点评论

- **URL**: `GET /api/spots/{id}/comments`
- **描述**: 获取景点评论列表
- **查询参数**:
  - `page`: 页码
  - `limit`: 每页数量
- **响应**:
  ```json
  {
    "success": true,
    "data": [
      {
        "id": 1,
        "content": "非常值得参观！",
        "rating": 5,
        "full_name": "李四",
        "avatar_url": "",
        "created_at": "2024-01-01"
      }
    ]
  }
  ```

### 3.2 添加评论

- **URL**: `POST /api/spots/{id}/comments`
- **描述**: 对景点添加评论
- **认证**: 需要
- **请求体**:
  ```json
  {
    "content": "评论内容",
    "rating": 5 // 1-5 分
  }
  ```

## 4. 景点互动

### 4.1 点赞/取消点赞

- **URL**: `POST /api/spots/{id}/like`
- **描述**: 点赞或取消点赞景点
- **认证**: 需要
- **响应**:
  ```json
  {
    "success": true,
    "data": {
      "liked": true,
      "likeCount": 1001
    }
  }
  ```

### 4.2 收藏/取消收藏

- **URL**: `POST /api/spots/{id}/favorite`
- **描述**: 收藏或取消收藏景点
- **认证**: 需要
- **响应**: 同点赞接口

## 5. 分类管理

### 5.1 获取分类列表

- **URL**: `GET /api/categories`
- **描述**: 获取所有景点分类
- **响应**:
  ```json
  {
    "success": true,
    "data": [
      {
        "id": 1,
        "name": "自然风光",
        "description": "自然景观",
        "spot_count": 50
      }
    ]
  }
  ```

### 5.2 创建分类

- **URL**: `POST /api/categories`
- **描述**: 创建新的景点分类
- **认证**: 需要
- **权限**: admin
- **请求体**:
  ```json
  {
    "name": "新分类",
    "description": "分类描述",
    "icon": "icon-name",
    "color": "#3B82F6"
  }
  ```

## 6. 用户管理

### 6.1 获取用户列表

- **URL**: `GET /api/users`
- **描述**: 获取用户列表（管理员功能）
- **认证**: 需要
- **权限**: admin
- **查询参数**:
  - `role`: 筛选角色

### 6.2 获取用户详情

- **URL**: `GET /api/users/{id}`
- **描述**: 获取用户详细信息
- **认证**: 需要

### 6.3 更新用户信息

- **URL**: `PUT /api/users/{id}`
- **描述**: 更新用户信息
- **认证**: 需要
- **权限**: 本人或 admin

## 7. 门票管理

### 7.1 获取门票列表

- **URL**: `GET /api/tickets`
- **描述**: 获取门票列表
- **查询参数**:
  - `spot_id`: 景点 ID
  - `type`: 门票类型

### 7.2 创建门票

- **URL**: `POST /api/tickets`
- **描述**: 为景点创建门票
- **认证**: 需要
- **权限**: guide, admin

## 8. 购物车

### 8.1 获取购物车

- **URL**: `GET /api/cart`
- **描述**: 获取用户购物车内容
- **认证**: 需要

### 8.2 添加到购物车

- **URL**: `POST /api/cart/items`
- **描述**: 添加门票到购物车
- **认证**: 需要
- **请求体**:
  ```json
  {
    "ticket_id": 1,
    "quantity": 2
  }
  ```

### 8.3 更新购物车

- **URL**: `PUT /api/cart/items/{id}`
- **描述**: 更新购物车项目数量
- **认证**: 需要

### 8.4 删除购物车项目

- **URL**: `DELETE /api/cart/items/{id}`
- **描述**: 从购物车删除项目
- **认证**: 需要

## 9. 订单管理

### 9.1 创建订单

- **URL**: `POST /api/orders`
- **描述**: 创建新订单
- **认证**: 需要
- **请求体**:
  ```json
  {
    "items": [
      {
        "ticket_id": 1,
        "quantity": 2
      }
    ],
    "contact_name": "张三",
    "contact_phone": "13800138000",
    "contact_email": "user@example.com",
    "notes": "备注信息"
  }
  ```

### 9.2 获取订单列表

- **URL**: `GET /api/orders`
- **描述**: 获取用户订单列表
- **认证**: 需要
- **查询参数**:
  - `status`: 订单状态筛选

### 9.3 获取订单详情

- **URL**: `GET /api/orders/{id}`
- **描述**: 获取订单详细信息
- **认证**: 需要

### 9.4 取消订单

- **URL**: `POST /api/orders/{id}/cancel`
- **描述**: 取消订单
- **认证**: 需要

## 10. 酒店管理

### 10.1 获取酒店列表

- **URL**: `GET /api/hotels`
- **描述**: 获取酒店列表
- **查询参数**:
  - `location`: 位置筛选
  - `star_rating`: 星级筛选

### 10.2 获取酒店详情

- **URL**: `GET /api/hotels/{id}`
- **描述**: 获取酒店详细信息

### 10.3 获取酒店房间

- **URL**: `GET /api/hotels/{id}/rooms`
- **描述**: 获取酒店房间列表

### 10.4 查询房间可用性

- **URL**: `GET /api/rooms/{id}/availability`
- **描述**: 查询房间在指定日期的可用性
- **查询参数**:
  - `check_in`: 入住日期
  - `check_out`: 退房日期

### 10.5 预订房间

- **URL**: `POST /api/hotels/book`
- **描述**: 预订酒店房间
- **认证**: 需要
- **请求体**:
  ```json
  {
    "room_id": 1,
    "check_in": "2024-01-01",
    "check_out": "2024-01-03",
    "guest_name": "张三",
    "guest_phone": "13800138000"
  }
  ```

## 11. 活动管理

### 11.1 获取活动列表

- **URL**: `GET /api/activities`
- **描述**: 获取旅游活动列表
- **查询参数**:
  - `spot_id`: 景点 ID
  - `type`: 活动类型
  - `start_date`: 开始日期

### 11.2 获取活动详情

- **URL**: `GET /api/activities/{id}`
- **描述**: 获取活动详情

### 11.3 报名活动

- **URL**: `POST /api/activities/{id}/join`
- **描述**: 报名参加活动
- **认证**: 需要

## 12. 新闻管理

### 12.1 获取新闻列表

- **URL**: `GET /api/news`
- **描述**: 获取新闻列表
- **查询参数**:
  - `page`: 页码
  - `limit`: 每页数量

### 12.2 获取新闻详情

- **URL**: `GET /api/news/{id}`
- **描述**: 获取新闻详情

### 12.3 创建新闻

- **URL**: `POST /api/news`
- **描述**: 创建新闻
- **认证**: 需要
- **权限**: admin

## 🔒 权限说明

### 角色权限等级
1. **user（普通用户）**
   - 浏览所有公开信息
   - 评论、点赞、收藏
   - 购买门票、预订酒店
   - 报名活动

2. **guide（导游）**
   - 拥有 user 的所有权限
   - 创建和管理景点
   - 创建门票和活动

3. **admin（管理员）**
   - 拥有所有权限
   - 管理所有数据
   - 管理用户

### API 权限矩阵

| 功能 | user | guide | admin |
|------|------|-------|-------|
| 浏览景点 | ✅ | ✅ | ✅ |
| 创建景点 | ❌ | ✅ | ✅ |
| 创建分类 | ❌ | ❌ | ✅ |
| 管理用户 | ❌ | ❌ | ✅ |
| 查看订单 | 自己 | 自己 | 全部 |
| 发布新闻 | ❌ | ❌ | ✅ |

## 📝 使用示例

### JavaScript/TypeScript

```typescript
// API 客户端示例
const apiClient = {
  request: async (url: string, options?: RequestInit) => {
    const token = localStorage.getItem('token')
    const response = await fetch(url, {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        ...(token && { Authorization: `Bearer ${token}` }),
        ...options?.headers,
      },
    })
    return response.json()
  },

  // 登录
  login: async (email: string, password: string) => {
    return apiClient.request('/api/auth/login', {
      method: 'POST',
      body: JSON.stringify({ email, password }),
    })
  },

  // 获取景点列表
  getSpots: async (page = 1, search = '') => {
    return apiClient.request(`/api/spots?page=${page}&search=${search}`)
  },

  // 点赞景点
  likeSpot: async (spotId: number) => {
    return apiClient.request(`/api/spots/${spotId}/like`, {
      method: 'POST',
    })
  },
}
```

## 🚨 错误代码

| 状态码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未认证或 Token 无效 |
| 403 | 权限不足 |
| 404 | 资源不存在 |
| 409 | 资源冲突（如重复操作） |
| 500 | 服务器内部错误 |

## 🔄 版本控制

API 版本通过 URL 路径管理：
- v1: `/api/v1/...` （当前版本）
- v2: `/api/v2/...` （未来版本）

当前所有接口都是 v1 版本。