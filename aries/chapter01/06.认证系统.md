# 06. è®¤è¯ç³»ç»Ÿ

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†æ—…æ¸¸æœåŠ¡ç³»ç»Ÿçš„ç”¨æˆ·è®¤è¯å’Œæƒé™ç®¡ç†æœºåˆ¶ã€‚

## ğŸ” è®¤è¯æœºåˆ¶æ¦‚è¿°

ç³»ç»Ÿé‡‡ç”¨ JWT (JSON Web Token) è¿›è¡Œç”¨æˆ·è®¤è¯ï¼Œå®ç°äº†æ— çŠ¶æ€çš„è®¤è¯æ–¹æ¡ˆã€‚

### è®¤è¯æµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Frontend as å‰ç«¯
    participant API as APIæœåŠ¡
    participant DB as æ•°æ®åº“

    User->>Frontend: è¾“å…¥ç™»å½•ä¿¡æ¯
    Frontend->>API: POST /api/auth/login
    API->>DB: éªŒè¯ç”¨æˆ·å‡­æ®
    DB-->>API: è¿”å›ç”¨æˆ·ä¿¡æ¯
    API->>API: ç”Ÿæˆ JWT Token
    API-->>Frontend: è¿”å› Token å’Œç”¨æˆ·ä¿¡æ¯
    Frontend->>Frontend: å­˜å‚¨ Token
    Frontend->>API: è¯·æ±‚å—ä¿æŠ¤èµ„æº + Token
    API->>API: éªŒè¯ Token
    API-->>Frontend: è¿”å›èµ„æº
```

## ğŸ“‹ JWT Token ç»“æ„

### Token è½½è· (Payload)

```json
{
  "userId": 1,
  "email": "user@example.com",
  "role": "user",
  "iat": 1640995200,
  "exp": 1641600000
}
```

### Token é…ç½®

- **ç®—æ³•**: HS256
- **è¿‡æœŸæ—¶é—´**: 7 å¤©
- **å¯†é’¥æ¥æº**: ç¯å¢ƒå˜é‡ `JWT_SECRET`

## ğŸ—‚ï¸ ç”¨æˆ·è§’è‰²ç³»ç»Ÿ

### è§’è‰²å®šä¹‰

1. **userï¼ˆæ™®é€šç”¨æˆ·ï¼‰**
   - æµè§ˆæ™¯ç‚¹ã€é…’åº—ã€æ´»åŠ¨
   - è¯„è®ºã€ç‚¹èµã€æ”¶è—
   - è´­ä¹°é—¨ç¥¨ã€é¢„è®¢é…’åº—
   - æŸ¥çœ‹ä¸ªäººè®¢å•

2. **guideï¼ˆå¯¼æ¸¸ï¼‰**
   - åŒ…å«æ™®é€šç”¨æˆ·çš„æ‰€æœ‰æƒé™
   - åˆ›å»ºå’Œç®¡ç†æ™¯ç‚¹
   - å‘å¸ƒé—¨ç¥¨å’Œæ´»åŠ¨
   - æŸ¥çœ‹æ¸¸å®¢ä¿¡æ¯

3. **adminï¼ˆç®¡ç†å‘˜ï¼‰**
   - åŒ…å«æ‰€æœ‰æƒé™
   - ç®¡ç†æ‰€æœ‰æ•°æ®
   - ç”¨æˆ·ç®¡ç†
   - ç³»ç»Ÿé…ç½®

### æƒé™å±‚çº§

```typescript
const roleHierarchy = {
  'admin': 3,
  'guide': 2,
  'user': 1
}
```

## ğŸ› ï¸ è®¤è¯å®ç°

### 1. è®¤è¯å·¥å…·å‡½æ•°

```typescript
// lib/auth.ts

// ç”Ÿæˆ JWT
export function generateToken(payload: any): string {
  return jwt.sign(payload, JWT_SECRET, { expiresIn: JWT_EXPIRES_IN })
}

// éªŒè¯ JWT
export function verifyToken(token: string): any {
  try {
    return jwt.verify(token, JWT_SECRET)
  } catch (error) {
    return null
  }
}

// å¯†ç åŠ å¯†
export async function hashPassword(password: string): Promise<string> {
  return await bcrypt.hash(password, 10)
}

// å¯†ç éªŒè¯
export async function comparePassword(password: string, hash: string): Promise<boolean> {
  return await bcrypt.compare(password, hash)
}
```

### 2. ç”¨æˆ·è®¤è¯

```typescript
// ç™»å½•è®¤è¯
export async function authenticateUser(email: string, password: string) {
  const user = dbGet(
    `SELECT id, email, password_hash, full_name, role FROM profiles WHERE email = ?`,
    [email]
  )

  if (!user || !user.password_hash) {
    return null
  }

  const isValidPassword = await comparePassword(password, user.password_hash)
  if (!isValidPassword) {
    return null
  }

  // ç§»é™¤å¯†ç å“ˆå¸Œ
  delete user.password_hash

  // ç”Ÿæˆ JWT
  const token = generateToken({
    userId: user.id,
    email: user.email,
    role: user.role
  })

  return { user, token }
}

// ç”¨æˆ·æ³¨å†Œ
export async function registerUser(userData: RegisterUserData) {
  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
  const existingUser = dbGet('SELECT id FROM profiles WHERE email = ?', [userData.email])
  if (existingUser) {
    throw new Error('ç”¨æˆ·å·²å­˜åœ¨')
  }

  // åŠ å¯†å¯†ç 
  const password_hash = await hashPassword(userData.password)

  // åˆ›å»ºç”¨æˆ·
  const { lastInsertRowid } = dbRun(
    `INSERT INTO profiles (email, password_hash, full_name, role) VALUES (?, ?, ?, ?)`,
    [userData.email, password_hash, userData.full_name, userData.role || 'user']
  )

  // è¿”å›ç”¨æˆ·ä¿¡æ¯å’Œ Token
  const user = dbGet(
    `SELECT id, email, full_name, role FROM profiles WHERE id = ?`,
    [lastInsertRowid]
  )

  const token = generateToken({
    userId: user.id,
    email: user.email,
    role: user.role
  })

  return { user, token }
}
```

### 3. API ä¸­é—´ä»¶

```typescript
// éªŒè¯è¯·æ±‚ä¸­çš„ JWT
export function validateAuth(request: Request): { user: any; error?: string } {
  const authHeader = request.headers.get('authorization')
  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return { user: null, error: 'æœªæä¾›è®¤è¯ä»¤ç‰Œ' }
  }

  const token = authHeader.substring(7)
  const decoded = verifyToken(token)
  if (!decoded) {
    return { user: null, error: 'æ— æ•ˆçš„è®¤è¯ä»¤ç‰Œ' }
  }

  // è·å–ç”¨æˆ·ä¿¡æ¯
  const user = dbGet(
    `SELECT id, email, full_name, role FROM profiles WHERE id = ?`,
    [decoded.userId]
  )

  if (!user) {
    return { user: null, error: 'ç”¨æˆ·ä¸å­˜åœ¨' }
  }

  return { user }
}

// è§’è‰²æƒé™æ£€æŸ¥
export function checkRole(userRole: string, requiredRole: string): boolean {
  const roleHierarchy = {
    'admin': 3,
    'guide': 2,
    'user': 1
  }

  return roleHierarchy[userRole as keyof typeof roleHierarchy] >=
         roleHierarchy[requiredRole as keyof typeof roleHierarchy]
}
```

## ğŸ” API è·¯ç”±ä¿æŠ¤

### 1. è®¤è¯æ£€æŸ¥

```typescript
// app/api/spots/route.ts
export async function POST(request: NextRequest) {
  const { user, error } = validateAuth(request)

  if (!user) {
    return NextResponse.json(
      { success: false, error: error || 'è¯·å…ˆç™»å½•' },
      { status: 401 }
    )
  }

  // ç»§ç»­å¤„ç†è¯·æ±‚...
}
```

### 2. æƒé™æ£€æŸ¥

```typescript
// app/api/categories/route.ts
export async function POST(request: NextRequest) {
  const { user } = await validateAuth(request)

  // æ£€æŸ¥æƒé™ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
  if (!checkRole(user.role, 'admin')) {
    return NextResponse.json(
      { success: false, error: 'æƒé™ä¸è¶³' },
      { status: 403 }
    )
  }

  // ç»§ç»­å¤„ç†è¯·æ±‚...
}
```

### 3. èµ„æºæ‰€æœ‰è€…æ£€æŸ¥

```typescript
// app/api/spots/[id]/route.ts
export async function PUT(request: NextRequest, { params }: { params: { id: string } }) {
  const { user } = await validateAuth(request)

  // æ£€æŸ¥èµ„æºæ˜¯å¦å­˜åœ¨
  const spot = dbGet('SELECT * FROM spots WHERE id = ?', [params.id])
  if (!spot) {
    return NextResponse.json(
      { success: false, error: 'èµ„æºä¸å­˜åœ¨' },
      { status: 404 }
    )
  }

  // æ£€æŸ¥æƒé™ï¼ˆç®¡ç†å‘˜æˆ–åˆ›å»ºè€…ï¼‰
  if (user.role !== 'admin' && spot.created_by !== user.id) {
    return NextResponse.json(
      { success: false, error: 'æƒé™ä¸è¶³' },
      { status: 403 }
    )
  }

  // ç»§ç»­å¤„ç†è¯·æ±‚...
}
```

## ğŸ”‘ å‰ç«¯è®¤è¯ç®¡ç†

### 1. Auth Context

```typescript
// contexts/auth-context.tsx
'use client'

interface AuthContextType {
  user: User | null
  token: string | null
  login: (email: string, password: string) => Promise<{ success: boolean; error?: string }>
  register: (data: RegisterData) => Promise<{ success: boolean; error?: string }>
  logout: () => void
  loading: boolean
}

export function AuthProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<User | null>(null)
  const [token, setToken] = useState<string | null>(null)

  useEffect(() => {
    // ä» localStorage è¯»å– token
    const storedToken = localStorage.getItem('token')
    if (storedToken) {
      setToken(storedToken)
      fetchCurrentUser(storedToken)
    }
  }, [])

  const login = async (email: string, password: string) => {
    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    })

    const data = await response.json()
    if (data.success) {
      setUser(data.data.user)
      setToken(data.data.token)
      localStorage.setItem('token', data.data.token)
    }
    return { success: data.success, error: data.error }
  }

  const logout = () => {
    setUser(null)
    setToken(null)
    localStorage.removeItem('token')
  }

  return (
    <AuthContext.Provider value={{ user, token, login, logout, loading: false }}>
      {children}
    </AuthContext.Provider>
  )
}
```

### 2. API å®¢æˆ·ç«¯

```typescript
// lib/api-client.ts
export async function apiRequest(
  url: string,
  options: RequestInit = {}
): Promise<ApiResponse> {
  const token = localStorage.getItem('token')

  const defaultHeaders: HeadersInit = {
    'Content-Type': 'application/json',
  }

  if (token) {
    defaultHeaders.Authorization = `Bearer ${token}`
  }

  try {
    const response = await fetch(url, {
      ...options,
      headers: {
        ...defaultHeaders,
        ...options.headers,
      },
    })

    const data = await response.json()

    if (response.status === 401) {
      // Token è¿‡æœŸï¼Œæ¸…é™¤å¹¶é‡å®šå‘åˆ°ç™»å½•é¡µ
      localStorage.removeItem('token')
      window.location.href = '/auth/login'
    }

    return {
      success: response.ok,
      data: data.data,
      error: data.error,
    }
  } catch (error) {
    return {
      success: false,
      error: 'ç½‘ç»œé”™è¯¯',
    }
  }
}
```

## ğŸ›¡ï¸ å®‰å…¨æªæ–½

### 1. å¯†ç å®‰å…¨

- ä½¿ç”¨ bcrypt è¿›è¡Œå¯†ç å“ˆå¸Œ
- ç›å€¼è½®æ•°è®¾ä¸º 10
- å¯†ç é•¿åº¦è‡³å°‘ 6 ä½

### 2. JWT å®‰å…¨

- ä½¿ç”¨å¼ºå¯†é’¥ï¼ˆè‡³å°‘ 32 å­—ç¬¦ï¼‰
- è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ï¼ˆ7 å¤©ï¼‰
- éªŒè¯ Token ç­¾å

### 3. è¾“å…¥éªŒè¯

```typescript
// ä½¿ç”¨ Zod è¿›è¡Œæ•°æ®éªŒè¯
const loginSchema = z.object({
  email: z.string().email('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€'),
  password: z.string().min(6, 'å¯†ç è‡³å°‘éœ€è¦ 6 ä½'),
})
```

### 4. é˜²æ­¢å¸¸è§æ”»å‡»

- **SQL æ³¨å…¥**: ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
- **XSS**: å¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œè½¬ä¹‰
- **CSRF**: ä½¿ç”¨ SameSite Cookie
- **æš´åŠ›ç ´è§£**: é™åˆ¶ç™»å½•å°è¯•æ¬¡æ•°

## ğŸ”„ Token åˆ·æ–°æœºåˆ¶

è™½ç„¶å½“å‰ Token æœ‰æ•ˆæœŸä¸º 7 å¤©ï¼Œä½†å¯ä»¥æ‰©å±•å®ç° Token åˆ·æ–°ï¼š

```typescript
// å¯é€‰çš„åˆ·æ–° Token å®ç°
export function generateRefreshToken(userId: number): string {
  return jwt.sign(
    { userId, type: 'refresh' },
    REFRESH_TOKEN_SECRET,
    { expiresIn: '30d' }
  )
}

// ä½¿ç”¨åˆ·æ–° Token è·å–æ–°çš„è®¿é—® Token
export async function refreshAccessToken(refreshToken: string) {
  try {
    const decoded = jwt.verify(refreshToken, REFRESH_TOKEN_SECRET)

    if (decoded.type !== 'refresh') {
      throw new Error('Invalid refresh token')
    }

    // è·å–ç”¨æˆ·ä¿¡æ¯
    const user = dbGet('SELECT id, email, role FROM profiles WHERE id = ?', [decoded.userId])

    if (!user) {
      throw new Error('User not found')
    }

    // ç”Ÿæˆæ–°çš„è®¿é—® Token
    const newAccessToken = generateToken({
      userId: user.id,
      email: user.email,
      role: user.role
    })

    return { accessToken: newAccessToken }
  } catch (error) {
    throw new Error('Invalid refresh token')
  }
}
```

## ğŸ“ æœ€ä½³å®è·µ

### 1. é”™è¯¯å¤„ç†

- ä¸è¦æš´éœ²æ•æ„Ÿä¿¡æ¯
- ä½¿ç”¨é€šç”¨çš„é”™è¯¯æ¶ˆæ¯
- è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

### 2. Token å­˜å‚¨

- ä½¿ç”¨ localStorageï¼ˆè€ƒè™‘ XSS é£é™©ï¼‰
- è€ƒè™‘ä½¿ç”¨ httpOnly Cookie
- å®ç°è‡ªåŠ¨ç™»å‡ºæœºåˆ¶

### 3. ä¼šè¯ç®¡ç†

- å®ç°"è®°ä½æˆ‘"åŠŸèƒ½
- å¤„ç†å¤šè®¾å¤‡ç™»å½•
- æä¾›å¼ºåˆ¶ç™»å‡ºå…¶ä»–è®¾å¤‡åŠŸèƒ½

### 4. æƒé™ç®¡ç†

- éµå¾ªæœ€å°æƒé™åŸåˆ™
- å®šæœŸå®¡æŸ¥æƒé™è®¾ç½®
- å®ç°æƒé™ç»§æ‰¿æœºåˆ¶

## ğŸš¨ å¸¸è§é—®é¢˜

### Q: Token å­˜åœ¨å“ªé‡Œï¼Ÿ

A: å½“å‰å®ç°å­˜å‚¨åœ¨ localStorageã€‚ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ httpOnly Cookieã€‚

### Q: å¦‚ä½•å®ç°"è®°ä½æˆ‘"ï¼Ÿ

A: å¯ä»¥ç”Ÿæˆæœ‰æ•ˆæœŸæ›´é•¿çš„ Token æˆ–ä½¿ç”¨åˆ·æ–° Token æœºåˆ¶ã€‚

### Q: å¦‚ä½•å¤„ç†å¹¶å‘ç™»å½•ï¼Ÿ

A: å¯ä»¥åœ¨ç”¨æˆ·è¡¨ä¸­æ·»åŠ  last_login å­—æ®µï¼Œæˆ–å®ç°è®¾å¤‡ç®¡ç†åŠŸèƒ½ã€‚

### Q: å¦‚ä½•æé«˜å®‰å…¨æ€§ï¼Ÿ

A:
- ä½¿ç”¨ HTTPS
- å®ç° IP ç™½åå•
- æ·»åŠ äºŒæ¬¡éªŒè¯
- ç›‘æ§å¼‚å¸¸ç™»å½•è¡Œä¸º

---

æœ¬è®¤è¯ç³»ç»Ÿæä¾›äº†å®Œæ•´çš„å®‰å…¨è§£å†³æ–¹æ¡ˆï¼Œå¦‚éœ€æ‰©å±•åŠŸèƒ½ï¼Œè¯·å‚è€ƒæœ€ä½³å®è·µéƒ¨åˆ†ã€‚